# Архитектурные правила проекта (WatchWise)

## 1. Общие положения

- **Архитектурный стиль:** Модульная архитектура (Modular Architecture). Строгое разделение ответственности по техническому назначению папок (как указано в структуре).
- **Стек:** Next.js 15 (App Router), TypeScript, Prisma, PostgreSQL, Tailwind CSS, Zustand.
- **Язык:**
  - Код (переменные, функции): Английский.
  - Комментарии и документация: Русский.

## 2. Структура папок (`src/`)

Код должен быть распределен строго по следующим директориям. Создание новых корневых папок запрещено без согласования.

### Основные слои:

1.  **`app/` (Routing Layer)**

    - **Назначение:** Маршрутизация Next.js, страницы (`page.tsx`), макеты (`layout.tsx`), API-роуты (`route.ts`).
    - **Правило:** Здесь **НЕТ** бизнес-логики. Файлы здесь только получают данные (через `services`) и рендерят компоненты.
    - **Запрещено:** Писать сложные `useEffect` или прямые запросы к БД внутри страниц.

2.  **`components/` (UI Layer)**

    - **Назначение:** Переиспользуемые React-компоненты.
    - **Структура:**
      - `ui/` — Базовые компоненты shadcn/ui (Button, Input).
      - `features/` — Сложные компоненты, реализующие конкретную функциональность (например, `VideoPlayer`, `QuizForm`).
    - **Правило:** Компоненты должны быть максимально "глупыми". Они получают данные через пропсы или стор (Zustand).
    - **Запрещено:** Импортировать `prisma` или вызывать БД напрямую.

3.  **`services/` (Business Logic Layer)**

    - **Назначение:** Ядро приложения. Здесь живет вся логика.
    - **Содержание:** Функции для работы с БД (Prisma), запросы к внешним API (Yandex, YouTube), обработка данных.
    - **Правило:** API Routes и Server Actions должны быть тонкими обертками, вызывающими методы из `services`.

4.  **`server-actions/` (Mutation Layer)**

    - **Назначение:** Функции с директивой `'use server'` для вызова с клиента.
    - **Правило:** Используются для обработки форм и кнопок. Обязательно валидируют входные данные (Zod) и вызывают `services`.

5.  **`store/` (Client State Layer)**
    - **Назначение:** Глобальный клиентский стейт (Zustand). Для серверного стейта используем React Query или нативные возможности Next.js.

### Вспомогательные слои:

- **`hooks/`**: Кастомные хуки. Повторяющаяся логика компонентов (например, `useVideoPlayer`, `useAuth`).
- **`config/`**: Конфигурация сторонних библиотек (экземпляр `prisma`, настройки `axios`, настройки `yandex-cloud`).
- **`shared/`**: Общие типы и схемы. Zod-схемы валидации, TypeScript-интерфейсы, используемые и на фронте, и на бэке.
- **`utils/`**: Чистые функции-хелперы (форматирование времени, обработка строк).
- **`providers/`**: React Context провайдеры (SessionProvider, ThemeProvider).
- **`constants/`**: Константы и переменные окружения.
- **`assets/`**: Статика (изображения, шрифты).

## 3. Поток данных и правила импорта

1.  **Server Components (`app/`)** -> вызывают -> **Services (`services/`)** -> вызывают -> **Database (Prisma)**.
2.  **Client Components (`components/`)** -> вызывают -> **Server Actions (`server-actions/`)** -> вызывают -> **Services**.
3.  **Запрещено:** Импортировать файлы из `app/` куда-либо.
4.  **Запрещено:** Вызывать Prisma (`db.ts`) внутри `components/`. Только в `services/` или `server-actions/`.

## 4. Правила валидации и безопасности

1.  **Zod:** Все входные данные в `server-actions` и `api` маршрутах должны проходить валидацию через Zod схемы.
2.  **DTO:** Типы данных (DTO) хранить в `shared/types` или рядом с сервисами.
3.  **Типизация:** Использование `any` строго запрещено. Если тип неизвестен, использовать `unknown` с последующей проверкой.
4.  **Секреты:** Никогда не хардкодить API-ключи. Использовать только `process.env`.

## 5. Инструкции для генерации кода (Для AI)

- Если я прошу создать функционал, сначала создай или обнови соответствующий сервис в `services/`.
- Затем создавай **Server Action** или **API Route**, использующий этот сервис.
- Только после этого создавай **UI-компонент** в `src/components/`.
- При создании компонента, используй `shadcn/ui` из `src/components/ui`.
- Затем собери это на странице в `app/`.
- Соблюдай структуру папок неукоснительно.
